{% extends "base.html" %}
{% block title %}Create Customer Bill{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4 fw-bold text-primary">
    <i class="bi bi-receipt"></i> Create Customer Bill
  </h2>

  <form method="POST" id="billForm">
    {% csrf_token %}

    <!-- ðŸ§¾ Customer Info -->
    <div class="card shadow-sm border-0 p-3 mb-4">
      <h5 class="fw-semibold text-secondary mb-3">Customer Information</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" name="customer_name" class="form-control" placeholder="Enter customer name" required>
        </div>
        <div class="col-md-4">
          <input type="text" name="customer_phone" class="form-control" placeholder="Enter phone number">
        </div>
        <div class="col-md-4">
          <input type="text" name="customer_address" class="form-control" placeholder="Enter address">
        </div>
      </div>
    </div>

    <!-- ðŸ›’ Product Section -->
    <div class="card shadow-sm border-0 p-3 mb-4">
      <h5 class="fw-semibold text-secondary mb-3">Select Products</h5>

      <table class="table table-bordered align-middle text-center" id="productTable">
        <thead class="table-primary">
          <tr>
            <th>Product</th>
            <th>HSN Code</th>
            <th>Qty</th>
            <th>Price (â‚¹)</th>
            <th>GST (%)</th>
            <th>CGST (â‚¹)</th>
            <th>SGST (â‚¹)</th>
            <th>Total (â‚¹)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr class="product-row">
            <td>
              <select name="item_id[]" class="form-select itemSelect" required>
                <option value="">-- Select Product --</option>
                {% for item in items %}
                <option 
                  value="{{ item.id }}" 
                  data-price="{{ item.price }}" 
                  data-gst="{{ item.gst_rate }}"
                  data-hsn="{{ item.hsn_code }}">
                  {{ item.name }} â€” â‚¹{{ item.price }}
                </option>
                {% endfor %}
              </select>
            </td>
            <td><input type="text" name="hsn_code[]" class="form-control hsn" readonly></td>
            <td><input type="number" name="quantity[]" class="form-control qty" min="1" value="1"></td>
            <td><input type="number" name="price[]" class="form-control price" step="0.01" min="0"></td>
            <td><input type="text" class="form-control gst" readonly></td>
            <td><input type="text" class="form-control cgst" readonly></td>
            <td><input type="text" class="form-control sgst" readonly></td>
            <td><input type="text" class="form-control total" readonly></td>
            <td><button type="button" class="btn btn-danger removeRow">âœ•</button></td>
          </tr>
        </tbody>
      </table>

      <div class="text-center mt-3">
        <button type="button" id="addProduct" class="btn btn-primary w-100">
          <i class="bi bi-plus-circle"></i> Add Product
        </button>
      </div>
    </div>

    <!-- ðŸ’° Total -->
    <div class="card shadow-sm border-0 p-3 mb-4">
      <h4 class="text-end text-success fw-bold">
        Grand Total (â‚¹): 
        <input type="text" id="grandTotal" class="border-0 text-end fw-bold" readonly style="width: 150px;">
      </h4>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-success px-5 fw-semibold">
        <i class="bi bi-check-circle"></i> Generate Bill
      </button>
    </div>
  </form>
</div>

<!-- âœ… JavaScript -->
<script>
  function updateRow(row) {
    const select = row.querySelector(".itemSelect");
    const qtyInput = row.querySelector(".qty");
    const priceInput = row.querySelector(".price");
    const gstInput = row.querySelector(".gst");
    const hsnInput = row.querySelector(".hsn");
    const cgstInput = row.querySelector(".cgst");
    const sgstInput = row.querySelector(".sgst");
    const totalInput = row.querySelector(".total");

    const selected = select.options[select.selectedIndex];
    const price = parseFloat(priceInput.value || selected.dataset.price || 0);
    const gst = parseFloat(selected.dataset.gst || 0);
    const qty = parseInt(qtyInput.value || 1);
    const hsn = selected.dataset.hsn || "";

    const taxable = price * qty;
    const gstAmount = (taxable * gst) / 100;
    const cgst = gstAmount / 2;
    const sgst = gstAmount / 2;
    const total = taxable + gstAmount;

    gstInput.value = gst.toFixed(2);
    hsnInput.value = hsn;
    cgstInput.value = cgst.toFixed(2);
    sgstInput.value = sgst.toFixed(2);
    totalInput.value = total.toFixed(2);

    updateGrandTotal();
  }

  function updateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll(".total").forEach(input => {
      grandTotal += parseFloat(input.value || 0);
    });
    document.getElementById("grandTotal").value = grandTotal.toFixed(2);
  }

  // Add new product row
  document.getElementById("addProduct").addEventListener("click", function() {
    const table = document.querySelector("#productTable tbody");
    const firstRow = table.querySelector("tr");
    const newRow = firstRow.cloneNode(true);

    newRow.querySelectorAll("input").forEach(input => input.value = "");
    newRow.querySelector(".qty").value = 1;
    newRow.querySelector(".itemSelect").selectedIndex = 0;

    table.appendChild(newRow);
  });

  // Dynamic event handling
  document.addEventListener("change", function(e) {
    if (e.target.classList.contains("itemSelect") || e.target.classList.contains("qty") || e.target.classList.contains("price")) {
      updateRow(e.target.closest(".product-row"));
    }
  });

  // Remove product row
  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("removeRow")) {
      const row = e.target.closest(".product-row");
      const table = row.parentNode;
      if (table.children.length > 1) {
        row.remove();
      } else {
        alert("You must have at least one product row!");
      }
      updateGrandTotal();
    }
  });
</script>

<style>
  .table input {
    text-align: center;
  }
  .table th, .table td {
    vertical-align: middle !important;
  }
  #addProduct {
    border-radius: 10px;
    font-weight: bold;
  }
</style>
{% endblock %}
